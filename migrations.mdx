---
title: Kafka Migration Guide
description: How to migrate the Laddr message bus from Redis to Kafka for production workloads.
---

# Kafka Migration Guide

This document describes the migration from Redis to Kafka as the message broker for the Laddr multi-agent system. Kafka provides better message persistence, horizontal scaling, and higher throughput for production workloads.

---

## Overview

Kafka offers durable, highly scalable messaging suitable for production. This guide walks through architecture changes, configuration updates, deployment, verification, and rollback steps to migrate from Redis to Kafka.

---

## Architecture Changes

### Message Broker Migration

**Before (Redis):**

- Message broker: Redis (pub/sub)
- Message persistence: Ephemeral (messages lost on restart)
- Scaling: Limited by single Redis instance
- Use case: Development and lightweight deployments

**After (Kafka):**

- Message broker: Apache Kafka with Zookeeper
- Message persistence: Durable (configurable retention)
- Scaling: Horizontal scaling with partitions and consumer groups
- Use case: Production deployments with high throughput

### Topic Structure

Kafka topics used by Laddr:

- `laddr.tasks.<agent_name>` - Task queue for each agent type
- `laddr.responses` - Response messages from agent execution

Consumer groups:

- `laddr-<agent_name>-workers` - Worker group for each agent type

---

## Configuration Changes

### Environment Variables (.env)

<CodeBlock
  code={`# Message Broker Configuration (Kafka)
KAFKA_BOOTSTRAP=kafka:9092
QUEUE_BACKEND=kafka

# Previous Redis configuration (commented out)
# REDIS_URL=redis://redis:6379/0
# QUEUE_BACKEND=redis`}
  language="bash"
/>

> **Important:** All services should use `kafka:9092` (the PLAINTEXT_HOST listener) for client connections. The `kafka:29092` port is for inter-broker communication only.

### Docker Compose Services

#### New Services Added

1. **Zookeeper** - Kafka cluster coordination
   - Port: 2181
   - Image: `confluentinc/cp-zookeeper:7.5.0`

2. **Kafka** - Message broker
   - Ports: 9092 (client connections), 9101 (JMX metrics)
   - Internal port: 29092 (inter-broker communication only)
   - Image: `confluentinc/cp-kafka:7.5.0`
   - Max message size: 10MB
   - **Critical:** Clients must connect to port 9092, NOT 29092

3. **Kafka UI** - Web-based monitoring interface
   - Port: 8080
   - Image: `provectuslabs/kafka-ui:latest`
   - Access: `http://localhost:8080`
   - Connects to: `kafka:9092`

#### Services Updated

- `api` - Updated environment variables and dependencies
- `coordinator_worker`, `researcher_worker`, `analyzer_worker`, `writer_worker`, `validator_worker` - All switched to Kafka configuration

---

## Deployment Instructions

### Prerequisites

Install Kafka support in Python:

<CodeBlock code={`pip install aiokafka>=0.11.0
# OR
pip install laddr[kafka]`} language="bash" />

### Starting the System

1. **Stop existing services:**

<CodeBlock code={`cd /path/to/your/project
docker-compose down`} language="bash" />

2. **Start with Kafka:**

<CodeBlock code={`docker-compose up -d`} language="bash" />

3. **Verify Kafka startup:**

<CodeBlock
  code={`# Check all services are running
docker-compose ps

# Check Kafka logs
docker-compose logs -f kafka`}
  language="bash"
/>

---

## Verification Steps

1. **Check Kafka topics:**

<CodeBlock code={`docker-compose exec kafka kafka-topics --list --bootstrap-server localhost:9092`} language="bash" />

Expected topics (created automatically):

- `laddr.tasks.coordinator`
- `laddr.tasks.researcher`
- `laddr.tasks.analyzer`
- `laddr.tasks.writer`
- `laddr.tasks.validator`
- `laddr.responses`

2. **Monitor worker logs:**

<CodeBlock
  code={`# All workers
docker-compose logs -f coordinator_worker researcher_worker analyzer_worker writer_worker validator_worker

# Specific worker
docker-compose logs -f coordinator_worker`}
  language="bash"
/>

3. **Check Kafka UI:**

Open `http://localhost:8080` and view topics, partitions, and consumer groups. Monitor message flow and lag.

4. **Test with API:**

<CodeBlock
  code={`curl -X POST http://localhost:8000/api/v1/run \
  -H "Content-Type: application/json" \\
  -d '{
    "workflow_name": "test_workflow",
    "initial_task": {
      "agent": "researcher",
      "inputs": {"query": "test"}
    }
  }'`}
  language="bash"
/>

---

## Monitoring

### Kafka UI Features

- **Topics:** View all topics, partitions, and replication
- **Consumer Groups:** Monitor consumer lag and partition assignment
- **Messages:** Browse and search messages in topics
- **Brokers:** Check broker health and metrics

### Important Metrics to Monitor

- Consumer lag (should be low)
- Message throughput (messages/second)
- Partition distribution across consumers
- Disk usage (Kafka stores messages on disk)

### Log Locations

<CodeBlock
  code={`# Kafka broker logs
docker-compose logs kafka

# Zookeeper logs
docker-compose logs zookeeper

# Worker logs (to see Kafka connection status)
docker-compose logs <worker_name>`}
  language="bash"
/>

---

## Scaling

### Horizontal Scaling of Workers

Scale any worker type:

<CodeBlock
  code={`# Scale coordinator workers to 3 instances
docker-compose up -d --scale coordinator_worker=3

# Scale all workers
docker-compose up -d \
  --scale coordinator_worker=3 \
  --scale researcher_worker=3 \
  --scale analyzer_worker=2 \
  --scale writer_worker=2 \
  --scale validator_worker=2`}
  language="bash"
/>

**Benefits:**

- Kafka automatically distributes partitions across consumer group members
- Each worker instance joins the consumer group
- Load balancing handled by Kafka

### Kafka Broker Scaling

For production, consider:

- Multiple Kafka brokers (not covered in single-node docker-compose)
- Replication factor > 1 for fault tolerance
- More partitions per topic for higher parallelism

---

## Troubleshooting

### Workers Not Connecting to Kafka

**Symptom:** Worker logs show connection errors like:

```
aiokafka.errors.KafkaConnectionError: Unable to bootstrap from [('kafka', 29092, <AddressFamily.AF_UNSPEC: 0>)]
```

**Root Cause:** Incorrect Kafka port configuration. Services should connect to `kafka:9092` (client listener), not `kafka:29092` (inter-broker listener).

**Solution:**

1. Verify all services use `KAFKA_BOOTSTRAP: kafka:9092` in `docker-compose.yml`
2. Check that workers have proper `depends_on` with healthcheck conditions:

<CodeBlock
  code={`depends_on:
  kafka:
    condition: service_healthy
  postgres:
    condition: service_healthy`}
  language="yaml"
/>

3. Restart services: `docker compose restart coordinator_worker researcher_worker`

### Topics Not Created

**Symptom:** `kafka-topics --list` shows no laddr topics

**Solution:**

- Topics are created automatically when first message is sent
- Send a test task through the API to trigger topic creation
- Or create manually:

<CodeBlock
  code={`docker-compose exec kafka kafka-topics --create \
  --bootstrap-server localhost:9092 \
  --topic laddr.tasks.coordinator \
  --partitions 3 \
  --replication-factor 1`}
  language="bash"
/>

### High Consumer Lag

**Symptom:** Kafka UI shows growing consumer lag

**Solution:**

- Scale up workers: `docker-compose up -d --scale <worker>=N`
- Check worker logs for errors/slowness
- Increase Kafka partitions for better parallelism

### Out of Memory Errors

**Symptom:** Kafka or workers crash with OOM

**Solution:**

- Increase Docker memory limits in `docker-compose.yml`
- Adjust Kafka heap size: `KAFKA_HEAP_OPTS=-Xmx1G -Xms1G`
- Reduce message retention period

---

## Rollback to Redis

If you need to revert to Redis:

1. **Update .env:**

<CodeBlock
  code={`REDIS_URL=redis://redis:6379/0
QUEUE_BACKEND=redis
# Comment out Kafka config
# KAFKA_BOOTSTRAP=kafka:9092`}
  language="bash"
/>

2. **Update docker-compose.yml:**

- Uncomment the `redis` service
- Remove `kafka` and `zookeeper` services (or comment out)
- Update all services to use `REDIS_URL` instead of `KAFKA_BOOTSTRAP`
- Change dependencies from `kafka` back to `redis`

3. **Restart:**

<CodeBlock code={`docker-compose down
docker-compose up -d`} language="bash" />

---

## Performance Tuning

### Kafka Configuration

Key settings in `docker-compose.yml`:

<CodeBlock
  code={`KAFKA_MESSAGE_MAX_BYTES=10485760           # 10MB max message size
KAFKA_REPLICA_FETCH_MAX_BYTES=10485760     # Match max message size
KAFKA_AUTO_CREATE_TOPICS_ENABLE=true       # Auto-create topics
KAFKA_DELETE_TOPIC_ENABLE=true             # Allow topic deletion`}
  language="bash"
/>

### Worker Configuration

Adjust in `.env` or `docker-compose.yml`:

- `MAX_CONCURRENT_TASKS` - Number of concurrent tasks per worker
- Consumer group settings in `message_bus.py`

---

## Additional Resources

- [Apache Kafka Documentation](https://kafka.apache.org/documentation/)
- [Kafka UI Documentation](https://docs.kafka-ui.provectus.io/)
- [Laddr Message Bus Documentation](../docs/configuration.md)
- [aiokafka Documentation](https://aiokafka.readthedocs.io/)

---

## Summary

✅ **Completed Migration Steps:**

1. Added Zookeeper and Kafka services to `docker-compose.yml`
2. Added Kafka UI for monitoring
3. Updated `.env` with Kafka configuration
4. Modified all services (API + workers) to use Kafka
5. Commented out Redis service (kept for easy rollback)

✅ **Benefits Achieved:**

- Message persistence across restarts
- Better horizontal scaling capabilities
- Production-ready message broker
- Visual monitoring with Kafka UI

✅ **Next Steps:**

1. Start the system: `docker-compose up -d`
2. Access Kafka UI: `http://localhost:8080`
3. Test with actual workflows
4. Monitor performance and scale as needed
